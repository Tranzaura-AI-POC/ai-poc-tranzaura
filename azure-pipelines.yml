# Azure Pipelines CI/CD for ai-poc-tranzaura
# Stages: Build -> Deploy-Dev -> Deploy-UAT -> Deploy-Prod
# NOTE: Fill pipeline variables (service connection names, app names, storage account, resource group)

trigger:
  branches:
    include:
      - main
      - develop

variables:
  - name: azureSubscription        # Azure service connection name (set in pipeline or variable group)
    value: 'Tranzaura-AI-POC-Azure'
  - name: resourceGroupDev
    value: 'ai-poc-dev-rg'
  - name: resourceGroupUat
    value: 'ai-poc-uat-rg'
  - name: resourceGroupProd
    value: 'ai-poc-prod-rg'
  - name: project
    value: 'ai-poc-tranzaura'
  - name: infraOwner
    value: 'team-name'
  - name: backendAppNameDev
    value: 'ai-poc-backend-dev'
  - name: backendAppNameUat
    value: 'ai-poc-backend-uat'
  - name: backendAppNameProd
    value: 'ai-poc-backend-prod'
  - name: frontendStorageAccountDev
    value: 'aipocfrontendstoragedev'
  - name: frontendStorageAccountUat
    value: 'ai-poc-frontend-storage-uat'
  - name: frontendStorageAccountProd
    value: 'ai-poc-frontend-storage-prod'
  - name: acrName
    value: ''
  - name: imageName
    value: 'ai-poc-tranzaura'
  - name: buildConfiguration
    value: 'Release'
  # Control which stages run. For initial dev-only deployments keep these false.
  - name: deployUat
    value: 'false'
  - name: deployProd
    value: 'false'
  # Dev infra provisioning (set to 'true' to run Bicep deploy step)
  - name: provisionInfra
    value: 'false'
  - name: location
    value: 'uksouth'
  - name: storageAccountNameDev
    value: 'aipocstoragedev'
  - name: storageAccountNameUat
    value: 'ai-poc-storage-uat'
  - name: storageAccountNameProd
    value: 'ai-poc-storage-prod'
  - name: webAppNameDev
    value: 'ai-poc-backend-dev'
  - name: webAppNameUat
    value: 'ai-poc-backend-uat'
  - name: webAppNameProd
    value: 'ai-poc-backend-prod'
  - name: appServicePlanNameDev
    value: 'ai-poc-plan-dev'
  - name: appServicePlanNameUat
    value: 'ai-poc-plan-uat'
  - name: appServicePlanNameProd
    value: 'ai-poc-plan-prod'

stages:
- stage: Build
  displayName: Build and Test
  jobs:
  - job: ValidateRun
    displayName: 'Validate pipeline run variables (ensure only Dev)'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "deployUat=$(deployUat)"
        echo "deployProd=$(deployProd)"
        if [ "$(deployUat)" = "true" ] || [ "$(deployProd)" = "true" ]; then
          echo "ERROR: deployUat or deployProd are true. Aborting to avoid non-Dev deployments."
          exit 1
        fi
      displayName: 'Ensure only Dev will be deployed'

  - job: LintYAML
    displayName: 'Lint pipeline YAML'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.x'
    - script: |
        python -m pip install --upgrade pip
        pip install yamllint
        echo "Running yamllint (errors will be reported but won't fail the pipeline)"
        yamllint azure-pipelines.yml || true
      displayName: 'Run yamllint (non-blocking)'

  - job: BuildBackend
    displayName: Build .NET backend
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.0.x'
    - script: |
        cd backend
        dotnet restore
        dotnet build --configuration $(buildConfiguration) --no-restore
      displayName: 'dotnet restore & build'
    - script: |
        cd backend
        dotnet test --configuration $(buildConfiguration) --no-build --verbosity normal
      displayName: 'Run unit tests (backend)'
    - script: |
        cd backend
        dotnet publish -c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/backend
      displayName: 'dotnet publish'
    - publish: $(Build.ArtifactStagingDirectory)/backend
      artifact: backend-drop

  - job: BuildFrontend
    displayName: Build Angular frontend
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '20.19.0'
    - script: |
        cd frontend
        npm ci
        npm run build -- --configuration production
      displayName: 'npm ci & build (frontend)'
    - publish: frontend/dist/fleet-frontend
      artifact: frontend-dist

- stage: Deploy_Dev
  displayName: Deploy to Dev
  dependsOn: Build
  jobs:
  - job: EnsureInfra
    displayName: 'Ensure Dev infrastructure (idempotent)'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: AzureCLI@2
      displayName: 'Check and optionally provision Dev infra'
      inputs:
        azureSubscription: '$(azureSubscription)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail
          echo "Verifying Dev resources exist (pipeline will not create them)."

          echo "Checking resource group $(resourceGroupDev)"
          if az group show -n $(resourceGroupDev) >/dev/null 2>&1; then
            echo "Resource group exists: $(resourceGroupDev)"
          else
            echo "ERROR: Resource group $(resourceGroupDev) not found. Create it manually before running the pipeline."
            exit 1
          fi

          echo "Checking App Service $(backendAppNameDev)"
          if az webapp show --name $(backendAppNameDev) --resource-group $(resourceGroupDev) >/dev/null 2>&1; then
            echo "App Service exists: $(backendAppNameDev)"
          else
            echo "ERROR: App Service $(backendAppNameDev) not found in RG $(resourceGroupDev). Create it manually before running the pipeline."
            exit 1
          fi

          echo "Checking Storage Account $(storageAccountNameDev)"
          if az storage account show -n $(storageAccountNameDev) -g $(resourceGroupDev) >/dev/null 2>&1; then
            echo "Storage account exists: $(storageAccountNameDev)"
          else
            echo "ERROR: Storage account $(storageAccountNameDev) not found in RG $(resourceGroupDev). Create it manually before running the pipeline."
            exit 1
          fi

          echo "Checking App Service Plan $(appServicePlanNameDev)"
          if az appservice plan show -n $(appServicePlanNameDev) -g $(resourceGroupDev) >/dev/null 2>&1; then
            echo "App Service plan exists: $(appServicePlanNameDev)"
          else
            echo "ERROR: App Service plan $(appServicePlanNameDev) not found in RG $(resourceGroupDev). Create it manually before running the pipeline."
            exit 1
          fi

  - deployment: DeployBackendDev
    displayName: Deploy backend to App Service (dev)
    dependsOn: EnsureInfra
    environment: 'dev'    # configure environment in Azure DevOps for approvals if desired
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: backend-drop
          - checkout: self
            clean: true
          - task: UseDotNet@2
            displayName: 'Use .NET SDK 8'
            inputs:
              packageType: 'sdk'
              version: '8.0.x'
          - task: AzureCLI@2
            displayName: 'Run DB migrations (optional)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Run EF Core migrations from pipeline if configured"
                # Expect a secret pipeline variable named FLEET_CONNECTION_STRING to be set (recommended)
                if [ -z "${FLEET_CONNECTION_STRING:-}" ]; then
                  echo "FLEET_CONNECTION_STRING not set; skipping migrations. To run migrations set pipeline secret 'FLEET_CONNECTION_STRING'."
                  exit 0
                fi

                set -eo pipefail
                echo "Changing to repository sources directory: $(Build.SourcesDirectory)"
                cd "$(Build.SourcesDirectory)"

                echo "Installing dotnet-ef tool..."
                dotnet --version || true
                export DOTNET_CLI_TELEMETRY_OPTOUT=1
                dotnet tool install --global dotnet-ef --version 8.* || true
                export PATH="$HOME/.dotnet/tools:$PATH"

                echo "Running migrations against Azure SQL using provided connection string"
                dotnet ef database update \
                  --project backend/FleetManagement.csproj \
                  --startup-project backend \
                  --configuration $(buildConfiguration) \
                  --connection "${FLEET_CONNECTION_STRING}"
          - task: AzureWebApp@1
            displayName: 'Deploy backend to App Service (ZIP deploy)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              appName: '$(backendAppNameDev)'
              package: '$(Pipeline.Workspace)/backend-drop'

  - deployment: DeployFrontendDev
    displayName: Deploy frontend to Static Website (dev)
    environment: 'dev'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: frontend-dist
          - task: AzureCLI@2
            displayName: 'Ensure static website and upload frontend to Storage Account (dev)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -eo pipefail
                echo "Ensuring static website settings and \$web container exist for $(frontendStorageAccountDev)"
                # Enable static website (idempotent) which ensures $web is available
                az storage blob service-properties update \
                  --account-name $(frontendStorageAccountDev) \
                  --static-website \
                  --index-document index.html \
                  --404-document 404.html \
                  --auth-mode login || true

                # Ensure $web container exists (create if missing)
                az storage container create \
                  --name '$web' \
                  --account-name $(frontendStorageAccountDev) \
                  --auth-mode login || true

                echo "Uploading frontend files to $(frontendStorageAccountDev) (\$web) using connection string secret"
                az storage blob upload-batch \
                  --connection-string "${FRONTEND_STORAGE_CONNECTION_STRING_DEV}" \
                  --source $(Pipeline.Workspace)/frontend-dist \
                  --destination '$web' \
                  --overwrite true

- stage: Deploy_UAT
  displayName: Deploy to UAT
  dependsOn: Deploy_Dev
  condition: and(succeeded(), eq(variables['deployUat'], 'true'))
  jobs:
  - deployment: DeployBackendUAT
    displayName: Deploy backend to App Service (uat)
    environment: 'uat'   # configure environment approvals in Azure DevOps UI
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: 'Provision UAT infra (Bicep)'
            condition: and(succeeded(), ne(variables['provisionInfra'], 'false'))
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -eo pipefail
                echo "Creating resource group $(resourceGroupUat) in $(location)"
                az group create -n $(resourceGroupUat) -l $(location)

                echo "Deploying infra/main.bicep using infra/uat.parameters.json"
                echo "What-If: infra/main.bicep (UAT)"
                az deployment group what-if \
                  --resource-group $(resourceGroupUat) \
                  --template-file infra/main.bicep \
                  --parameters @infra/uat.parameters.json \
                  --output json > $(Pipeline.Workspace)/whatif-uat.json || true

                echo "what-if saved to $(Pipeline.Workspace)/whatif-uat.json (no blocking in UAT)"

                echo "Deploying infra/main.bicep using infra/uat.parameters.json"
                az deployment group create \
                  --resource-group $(resourceGroupUat) \
                  --template-file infra/main.bicep \
                  --parameters @infra/uat.parameters.json
          - download: current
            artifact: backend-drop
          - task: AzureWebApp@1
            displayName: 'Deploy backend to App Service (UAT)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              appName: '$(backendAppNameUat)'
              package: '$(Pipeline.Workspace)/backend-drop'

  - deployment: DeployFrontendUAT
    displayName: Deploy frontend to Static Website (uat)
    environment: 'uat'
    pool:
      vmImage: 'ubuntu-latest'
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: frontend-dist
          - task: AzureCLI@2
            displayName: 'Ensure static website and upload frontend to Storage Account (uat)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                echo "Ensuring static website settings and \$web container exist for $(frontendStorageAccountUat)"
                az storage blob service-properties update \
                  --account-name $(frontendStorageAccountUat) \
                  --static-website \
                  --index-document index.html \
                  --404-document 404.html \
                  --auth-mode login || true

                az storage container create \
                  --name '$web' \
                  --account-name $(frontendStorageAccountUat) \
                  --auth-mode login || true

                echo "Uploading frontend files to $(frontendStorageAccountUat) (\$web) using connection string secret"
                az storage blob upload-batch \
                  --connection-string "${FRONTEND_STORAGE_CONNECTION_STRING_UAT}" \
                  --source $(Pipeline.Workspace)/frontend-dist \
                  --destination '$web' \
                  --overwrite true
          - task: NodeTool@0
            displayName: 'Run Playwright e2e against UAT'
            inputs:
              versionSpec: '20.19.0'
          - script: |
              chmod +x ./scripts/run-playwright-staging.sh || true
              export PLAYWRIGHT_BASE_URL=$(stagingFrontendUrl)
              ./scripts/run-playwright-staging.sh
            displayName: 'Run Playwright e2e (UAT)'
            env:
              PLAYWRIGHT_BASE_URL: $(stagingFrontendUrl)
          - script: |
              chmod +x ./scripts/run-smoke-tests.sh || true
              export API_BASE_URL=$(stagingApiUrl)
              ./scripts/run-smoke-tests.sh
            displayName: 'Run smoke tests (UAT)'
            env:
              API_BASE_URL: $(stagingApiUrl)

- stage: Deploy_Prod
  displayName: Deploy to Production
  dependsOn: Deploy_UAT
  condition: and(succeeded(), eq(variables['deployProd'], 'true'))
  jobs:
  - job: ManualApproval
    displayName: 'Manual approval (Gate)'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - script: |
        echo "Manual approval placeholder: enable production by setting variable 'deployProd' to true in the pipeline run or UI."
      displayName: 'Manual approval placeholder'

  - deployment: DeployBackendProd
    displayName: Deploy backend to App Service (prod)
    environment: 'prod'   # configure environment approvals & checks in Azure DevOps
    pool:
      vmImage: 'ubuntu-latest'
    dependsOn: ManualApproval
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: 'Provision Prod infra (Bicep)'
            condition: and(succeeded(), ne(variables['provisionInfra'], 'false'))
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                echo "Creating resource group $(resourceGroupProd) in $(location)"
                az group create -n $(resourceGroupProd) -l $(location)

                echo "Deploying infra/main.bicep using infra/prod.parameters.json"
                echo "What-If: infra/main.bicep (Prod)"
                az deployment group what-if \
                  --resource-group $(resourceGroupProd) \
                  --template-file infra/main.bicep \
                  --parameters @infra/prod.parameters.json \
                  --output json > $(Pipeline.Workspace)/whatif-prod.json || true

                echo "Checking what-if output for destructive changes..."
                if grep -Eq '"changeType"\s*:\s*"(Delete|Replace)"' $(Pipeline.Workspace)/whatif-prod.json; then
                  echo "ERROR: Destructive changes detected by what-if. Aborting deployment."
                  cat $(Pipeline.Workspace)/whatif-prod.json
                  exit 1
                fi

                echo "Deploying infra/main.bicep using infra/prod.parameters.json"
                az deployment group create \
                  --resource-group $(resourceGroupProd) \
                  --template-file infra/main.bicep \
                  --parameters @infra/prod.parameters.json
          - download: current
            artifact: backend-drop
          - task: AzureCLI@2
            displayName: 'Run DB migrations (optional)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Run EF Core migrations from pipeline if configured"
                # Expect a secret pipeline variable named FLEET_CONNECTION_STRING to be set (recommended)
                if [ -z "${FLEET_CONNECTION_STRING:-}" ]; then
                  echo "FLEET_CONNECTION_STRING not set; skipping migrations. To run migrations set pipeline secret 'FLEET_CONNECTION_STRING'."
                  exit 0
                fi

                set -euo pipefail
                echo "Installing dotnet-ef tool..."
                dotnet --version || true
                export DOTNET_CLI_TELEMETRY_OPTOUT=1
                dotnet tool install --global dotnet-ef --version 8.* || true
                export PATH="$HOME/.dotnet/tools:$PATH"

                echo "Running migrations against Azure SQL using provided connection string"
                # Run from repo root and target the backend project
                dotnet ef database update \
                  --project backend/FleetManagement.csproj \
                  --startup-project backend \
                  --configuration $(buildConfiguration) \
                  --connection "${FLEET_CONNECTION_STRING}"
          - task: AzureWebApp@1
            displayName: 'Deploy backend to App Service (Prod)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              appName: '$(backendAppNameProd)'
              package: '$(Pipeline.Workspace)/backend-drop'

  - deployment: DeployFrontendProd
    displayName: Deploy frontend to Static Website (prod)
    environment: 'prod'
    pool:
      vmImage: 'ubuntu-latest'
    dependsOn: ManualApproval
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: frontend-dist
          - task: AzureCLI@2
            displayName: 'Ensure static website and upload frontend to Storage Account (prod)'
            inputs:
              azureSubscription: 'Tranzaura-AI-POC-Azure'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                set -euo pipefail
                echo "Ensuring static website settings and \$web container exist for $(frontendStorageAccountProd)"
                az storage blob service-properties update \
                  --account-name $(frontendStorageAccountProd) \
                  --static-website \
                  --index-document index.html \
                  --404-document 404.html \
                  --auth-mode login || true

                az storage container create \
                  --name '$web' \
                  --account-name $(frontendStorageAccountProd) \
                  --auth-mode login || true

                echo "Uploading frontend files to $(frontendStorageAccountProd) (\$web) using connection string secret"
                az storage blob upload-batch \
                  --connection-string "${FRONTEND_STORAGE_CONNECTION_STRING_PROD}" \
                  --source $(Pipeline.Workspace)/frontend-dist \
                  --destination '$web' \
                  --overwrite true

# Notes:
# - Set pipeline variables (azureSubscription, resourceGroup, backendAppName, frontendStorageAccount, acrName) in the pipeline UI or use a variable group linked to Key Vault.
# - Consider replacing frontend Storage Account deployment with Azure Static Web Apps or CDN depending on requirements.
# - Use Azure Key Vault task or variable group to inject secrets (DB connection string, Key Vault secrets) into the pipeline securely.
# - Configure environment approvals/gates in Azure DevOps for 'uat' and 'prod' environments.
# - For container-based deploys: add Docker build/push to ACR and update AzureWebApp or Container Apps deployment to use the image.
